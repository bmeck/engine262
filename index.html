<!DOCTYPE html>
<html>
  <head>
    <style>
      textarea {
        font-family: monospace;
        display: block;
      }
      textarea:disabled {
        color: black;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.2/codemirror.min.css">
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.2/mode/javascript/javascript.min.js"></script>
    <h1>engine262</h1>
    <h2>A self-hosted JavaScript engine for development and exploration.</h2>
    <a href="https://github.com/engine262/engine262">engine262 on GitHub</a>

    <p>Features</p>
    <ul id="features"></ul>

    <textarea id="input" autocomplete="off">print('Hello, World!');</textarea>

    <button id="run">Evaluate</button>

    <p>Output:</p>

    <textarea id="output" cols="80" autocomplete="off" disabled></textarea>

    <script>
      const featureList = document.querySelector('#features');
      const input = document.querySelector('#input');
      const output = document.querySelector('#output');

      let featuresPopulated = false;
      const features = new Set();
      let worker;

      function respawn() {
        if (worker) {
          worker.terminate();
        }
        worker = new Worker('./worker.js');
        worker.addEventListener('message', ({ data }) => {
          if (data.log) {
            console.log(...data.log);
            data.log.forEach((l) => {
              output.value += l;
              output.value += ' ';
            });
            output.value += '\n';
          } else if (data.error) {
            console.error(data.error);
            output.value += data.error;
            output.value += '\n';
          } else if (data.FEATURES) {
            if (!featuresPopulated) {
              featuresPopulated = true;
              data.FEATURES
                .forEach(({ name }) => {
                  const li = document.createElement('li');
                  const input = document.createElement('input');
                  input.type = 'checkbox';
                  input.addEventListener('click', () => {
                    if (input.checked) {
                      features.add(name);
                    } else {
                      features.delete(name);
                    }
                    respawn();
                    worker.postMessage({ features: [...features] });
                  });
                  li.appendChild(input);
                  const span = document.createElement('span');
                  span.textContent = name;
                  li.appendChild(span);
                  featureList.appendChild(li);
                });
              worker.postMessage({ features: [...features] });
            }
          }
        });
      }

      respawn();

      const editor = CodeMirror.fromTextArea(input, {
        lineNumbers: true,
        mode: 'javascript',
      });

      document.querySelector('#run').addEventListener('click', () => {
        output.value = '';
        worker.postMessage({ input: editor.getValue() });
      });
    </script>
  </body>
</html>
