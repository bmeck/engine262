<!DOCTYPE html>
<html>
  <head>
    <h1>engine262</h1>
    <style>
      textarea {
        font-family: monospace;
        display: block;
      }
    </style>
  </head>
  <body>
    <p>Features</p>
    <ul id="features"></ul>

    <textarea id="input" cols=80>print('Hello, World!');</textarea>

    <button id="run">Evaluate</button>

    <textarea disabled id="output" cols=80></textarea>

    <script>
      const featureList = document.querySelector('#features');
      const input = document.querySelector('#input');
      const output = document.querySelector('#output');

      let featuresPopulated = false;
      const features = new Set();
      let worker;

      function respawn() {
        if (worker) {
          worker.terminate();
        }
        worker = new Worker('./worker.js');
        worker.addEventListener('message', ({ data }) => {
          if (data.log) {
            console.log(...data.log);
            data.log.forEach((l) => {
              output.value += l;
              output.value += ' ';
            });
            output.value += '\n';
          } else if (data.error) {
            console.error(data.error);
            output.value += data.error;
            output.value += '\n';
          } else if (data.FEATURES) {
            if (!featuresPopulated) {
              featuresPopulated = true;
              data.FEATURES
                .forEach(({ name }) => {
                  const li = document.createElement('li');
                  const input = document.createElement('input');
                  input.type = 'checkbox';
                  input.addEventListener('click', () => {
                    if (input.checked) {
                      features.add(name);
                    } else {
                      features.delete(name);
                    }
                    respawn();
                    worker.postMessage({ features: [...features] });
                  });
                  li.appendChild(input);
                  const span = document.createElement('span');
                  span.textContent = name;
                  li.appendChild(span);
                  featureList.appendChild(li);
                });
              worker.postMessage({ features: [...features] });
            }
          }
        });
      }

      respawn();

      document.querySelector('#run').addEventListener('click', () => {
        output.value = '';
        worker.postMessage({ input: input.value });
      });
    </script>
  </body>
</html>
